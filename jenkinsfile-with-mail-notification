pipeline {
    agent any

    stages {
        stage('Scan with Trivy') {
            when { branch 'dev' }  // Or your branch condition
            steps {
                // Example: Run Trivy and save output to workspace
                sh '''
                    trivy image --format json --output trivy-report.json your-docker-image:tag
                    trivy image --format template --template "@contrib/html.tpl" --output trivy-report.html your-docker-image:tag
                '''
            }
        }
        // ... other stages ...
    }

    post {
        always {
            // Step 1: Send email with attachment/body (files still exist here)
            script {
                if (fileExists('trivy-report.json')) {
                    // Option A: Basic mail (no HTML/attachments) - uses Mailer plugin
                    // mail to: 'team@example.com',
                    //      subject: "Trivy Scan Results - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                    //      body: readFile('trivy-report.json')  // Embed JSON as text

                    // Option B: Rich email with attachments (recommended - Email Ext plugin)
                    emailext (
                        to: 'team@example.com',  // Or use ${env.NOTIFIER_EMAIL} var
                        subject: "Trivy Scan Report - ${env.JOB_NAME} #${env.BUILD_NUMBER} (${currentBuild.result})",
                        body: """
                            <h2>Trivy Scan Summary</h2>
                            <p>Branch: ${env.BRANCH_NAME}</p>
                            <p>Build Status: ${currentBuild.result}</p>
                            <pre>${readFile('trivy-report.json').take(2000)}...</pre>  <!-- Embed snippet -->
                            <p>Full HTML report attached. Check Jenkins for details.</p>
                        """,
                        mimeType: 'text/html',
                        attachmentsPattern: 'trivy-report.*'  // Attaches json, html, etc. (supports wildcards)
                    )
                    echo 'Email sent with Trivy results'
                } else {
                    echo 'No Trivy report found - skipping email'
                }
            }

            // Step 2: (Optional) Archive artifacts in Jenkins UI for download later
            archiveArtifacts artifacts: 'trivy-report.*', allowEmptyArchive: true, fingerprint: true

            // Step 3: Now safe to clean - email & archive are done
            echo 'Cleaning up workspace'
            cleanWs(
                cleanWhenNotBuilt: false,
                cleanWhenFailure: true,
                cleanWhenAborted: true,
                cleanWhenSuccess: true
            )  // Extra options for finer control
        }
    }
}
